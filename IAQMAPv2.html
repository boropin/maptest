<head>
<title>IAQ Contour Map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// (c) Katsuhiko Araki 2023/12/13

var now = new Date();
function LoadProc() {

const param = Object.fromEntries(new URLSearchParams(window.location.search));

var da = param.da;
var x =  param.x.split(',').map(Number);
var y = param.y.split(',').map(Number);
var z =  param.z.split(',');
var pwidth = Number(param.pwidth);
var pheight = Number(param.pheight);
var iaqurl = param.iaqurl;


var pmargin = 50;

var width = pwidth + 4.6 * pmargin;
var height = pheight + 3.5 * pmargin;


var das = ['tmp','hum','co2','wbgt','pm25','voc','press','uv'];
var danames = ['Temperature','Relative Humidity','CO2','WBGT','PM2.5','VOC Index','Barometric Pressure','UV Index'];

var ncontours  = [180,180,30,180,30,30,30,90];
var colorscale = [
  'Jet',
   [
      ['0.0', 'rgb(165,0,38)'],
      ['0.111111111111', 'rgb(215,48,39)'],
      ['0.222222222222', 'rgb(244,109,67)'],
      ['0.333333333333', 'rgb(253,174,97)'],
      ['0.444444444444', 'rgb(254,224,144)'],
      ['0.555555555556', 'rgb(224,243,248)'],
      ['0.666666666667', 'rgb(171,217,233)'],
      ['0.777777777778', 'rgb(116,173,209)'],
      ['0.888888888889', 'rgb(69,117,180)'],
      ['1.0', 'rgb(49,54,149)']
    ],
  'Jet','Jet','Jet','Jet','Jet','Jet'
];

var zmin = [5 ,  0, 400, 0,  0,  0, 800, 0];
var zmax = [45,100,1500,40,250,250,1200,11];


var num = das.indexOf(da);
if ( num == -1){
    num = 0;
}


console.log(num);


var x1=x.concat();
var x1=x.concat();
var y1=y.concat();
x1.shift();
y1.shift();
x1.pop();
y1.pop();

var data = [{
    x: x,
    y: y,
    z: z,
    label: ['','','','','','','','','','','',''],

    type: 'contour',
    contours: {
        showlabels: true,

    },
    ncontours: ncontours[num],
    colorscale: colorscale[num],
    showscale: true,
    autocontour: true,
    
    
    zmin:  zmin[num],
    zmax:  zmax[num],
    line:{
        smoothing: 1,
    },
    name: 'Point',
},
{
    x: x1,
    y: y1,
    type: 'scatter',
    mode: "markers",

    marker: {
      color: 'white',
      size: 5,
      line: {
        color: 'black',
        width: 1
      }
    },
    name: 'Plot',

}];




var layout = {
    height: height,
    width: width,
    title: '<B>IAQ Contour Map / '+danames[num]+'</B>',

    xaxis: {
        ticks: 'outside',
        title:'x[m]',
        showticklabels: true 
    },
    yaxis: {
        ticks: 'outside',
        title:'y[m]',
        showticklabels: true
    }

};

var request = new XMLHttpRequest();
request.open('GET',iaqurl, true);
request.responseType = 'json';
request.send();
request.onload = () => {
    const jsonData = request.response;
    const datastr = JSON.stringify(jsonData,null,'    ');
    //console.log(datastr);

    const obj = JSON.parse(datastr);

    //console.log(data[0].x[11], data[0].y[11], data[0].z[11]);


    for (var i = 1; i < (obj.length)+1; i++){

        if(num ==0){
            data[0].z[i] = obj[i-1].temperature  |'' ;
        };
        if(num ==1){
            data[0].z[i] = obj[i-1].relativeHumidity |'' ;
        };
        if(num ==2){
            data[0].z[i] = obj[i-1].co2 |'' ;
        };
        if(num ==3){
            //data[0].z[i] = obj[i-1].wbgt;
            var tmp = obj[i-1].temperature |'' ;
            var hum = obj[i-1].relativeHumidity |'' ;
            if(tmp == '' || hum == ''){
                data[0].z[i] = 0;
            } else {
                data[0].z[i] = Math.round( (0.725 * tmp + 0.0368 * hum + 0.00364 * tmp * hum - 3.246 ) * 10 )/10;
            }
        };
        if(num ==4){
//            data[0].z[i] = obj[i-1].PM2_5 | 100;
            data[0].z[i] = obj[i-1].PM2_5 |'' ;

        };
        if(num ==5){
//            data[0].z[i] = obj[i-1].tvoc | 100;
            data[0].z[i] = obj[i-1].tvoc | '';
        };
        if(num ==6){
            data[0].z[i] = obj[i-1].BarometricPressure | 1013.24;
        };
        if(num ==7){
//            data[0].z[i] = obj[i-1].UVIndex | 2;           
            data[0].z[i] = obj[i-1].UVIndex | '';           
        };


        data[0].label[i] = obj[i-1].sensorName;
        console.log(i, data[0].x[i], data[0].y[i], data[0].z[i],data[0].label[i]);
    }

    Plotly.newPlot('graph', data, layout, {displayModeBar: true});

    var target = document.getElementById("DateTimeDisp");

    var Year = now.getFullYear();
    var Month = now.getMonth()+1;
    var Date = now.getDate();
    var Hour = now.getHours();
    var Min = now.getMinutes();
    var Sec = now.getSeconds();
    target.innerHTML = Year + "/" + Month + "/" + Date + " " + Hour + ":" + Min + ":" + Sec+" update.";


    //  link
    for(var i=0;i<das.length;i++){
       var da2 = das[i];
       var params2 = {
           da: da2,
           x: x,
           y: y,
           z: z,
           pwidth : pwidth,
           pheight : pheight,
           iaqurl: iaqurl
       }

       var urlSearchParam2 =  new URLSearchParams(params2).toString();
       var tag2 = document.getElementById(das[i]);

       tag2.href = "IAQMAPv2.html?" + urlSearchParam2;
       
    }
    
    setTimeout(function () {
        location.reload();
    }, 300000);
  }
}
</script> 

</head>

<body onload="LoadProc();">
<div id="graph" align = center></div>
<div id="DateTimeDisp" align = center></div>
<table border="1" align = center  style="font-size: 10pt;">
<caption>Select: </caption><tr>
<td><a id="tmp" href="IAQMAPv2.html?da=tmp">Temperature</a></td>
<td><a id="hum" href="IAQMAPv2.html?da=hum">Relative Humidity</a></td>
<td><a id="co2" href="IAQMAPv2.html?da=co2">CO2</a></td>
<td><a id="wbgt" href="IAQMAPv2.html?da=wbgt">WBGT</a></td>
<td><a id="pm25" href="IAQMAPv2.html?da=pm25">PM2.5</a></td>
<td><a id="voc" href="IAQMAPv2.html?da=voc">VOC Index</a></td>
<td><a id="press" href="IAQMAPv2.html?da=press">Barometric Pressure</a></td>
<td><a id="uv" href="IAQMAPv2.html?da=uv">UV Index</a></td>
</tr></table>

</body>


